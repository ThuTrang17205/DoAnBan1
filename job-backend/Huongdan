# ğŸ¯ Matching System - HoÃ n Chá»‰nh

## ğŸ“‹ Tá»”NG QUAN

Há»‡ thá»‘ng matching rule-based cho Job Portal, táº­n dá»¥ng Ä‘áº§y Ä‘á»§ schema database vá»›i cÃ¡c báº£ng quan há»‡.

### Kiáº¿n trÃºc:
```
Route â†’ Controller â†’ Service â†’ Model â†’ Database
                  â†“
             Text Extractors (CV & Job)
```

---

## ğŸ—„ï¸ DATABASE SCHEMA

### Báº£ng chÃ­nh:
- **users**: User accounts (candidate/employer)
- **user_profiles**: Extended candidate profiles
- **user_cvs**: CV file storage
- **cv_parsed_data**: Parsed CV data (JSONB + relations)
- **jobs**: Job listings
- **job_parsed_data**: Parsed job requirements (JSONB + relations)
- **matching_scores**: Matching results

### Báº£ng quan há»‡ (M-N):
- **skills_master**: Skills dictionary
- **candidate_skills**: User â†” Skill (vá»›i proficiency_level: 1-5)
- **job_skills**: Job â†” Skill (vá»›i required_level: 1-5, is_required, weight)
- **education_levels**: Education levels vá»›i rank

### Báº£ng há»— trá»£:
- **matching_config**: Scoring weights
- **matching_logs**: Activity tracking
- **saved_cvs**: Employer saved candidates
- **vip_packages** + **subscriptions**: VIP features

---

## ğŸš€ CÃCH Sá»¬ Dá»¤NG

### 1. Parse CV trÆ°á»›c khi matching

```javascript
const CVParserService = require('./services/cvParser.service');

// Parse 1 CV
const parsed = await CVParserService.parseByCvId(cvId);

// Káº¿t quáº£ lÆ°u vÃ o: cv_parsed_data
// - skills (JSONB array)
// - total_experience_years
// - education_level
// - current_position
// - email, phone
```

### 2. Parse Job trÆ°á»›c khi matching

```javascript
const JobParserService = require('./services/jobParser.service');

// Parse 1 Job
const parsed = await JobParserService.parseByJobId(jobId);

// Káº¿t quáº£ lÆ°u vÃ o: job_parsed_data
// - required_skills (JSONB array)
// - min_experience_years, max_experience_years
// - required_education_level
// - job_level
```

### 3. Cháº¡y Matching

```javascript
const matchingService = require('./services/matching.service');

// Match candidates cho 1 job
const result = await matchingService.matchCandidatesForJob(jobId, {
  candidateIds: [1, 2, 3], // Optional: match specific candidates
  limit: 100,              // Limit sá»‘ candidates
  useRelations: true       // DÃ¹ng candidate_skills/job_skills tables
});

// Response:
{
  job_id: 123,
  total_candidates: 50,
  qualified_candidates: 15,
  matches: [
    {
      candidate_id: 5,
      candidate_name: "John Doe",
      total_score: 85.5,
      skills_score: 90,
      experience_score: 85,
      education_score: 80,
      location_score: 100,
      salary_score: 70,
      is_qualified: true
    },
    ...
  ]
}
```

### 4. Láº¥y káº¿t quáº£ Ä‘Ã£ match (tá»« DB)

```javascript
// Láº¥y top candidates cho job
const candidates = await matchingService.getTopCandidates(jobId, {
  minScore: 60,
  limit: 20,
  qualifiedOnly: true
});

// Láº¥y recommended jobs cho candidate
const jobs = await matchingService.getRecommendedJobs(candidateId, {
  minScore: 60,
  limit: 20
});
```

---

## ğŸ§® THUáº¬T TOÃN MATCHING

### Scoring Components:

#### 1. **Skills Score (50%)** - Quan trá»ng nháº¥t

Logic:
- Required skill missing â†’ **0 Ä‘iá»ƒm** (Critical!)
- Optional skill missing â†’ **50 Ä‘iá»ƒm**
- Skill cÃ³ nhÆ°ng level khÃ´ng Ä‘á»§:
  - Level Ä‘á»§ hoáº·c cao hÆ¡n â†’ **100 Ä‘iá»ƒm**
  - KÃ©m 1 level â†’ **80 Ä‘iá»ƒm**
  - KÃ©m >1 level â†’ **60 Ä‘iá»ƒm**

```javascript
// VÃ­ dá»¥:
Job requires:
  - JavaScript (required, level 4 - Advanced)
  - React (required, level 3 - Intermediate)
  - NodeJS (optional, level 3)

Candidate has:
  - JavaScript (level 5 - Expert) â†’ 100 * 1.0 = 100
  - Vue (level 4) â†’ Not matched
  - React missing â†’ 0 * 1.0 = 0

Skills Score = (100 + 0 + 50) / 3 = 50%
â†’ NOT QUALIFIED (vÃ¬ React required bá»‹ thiáº¿u)
```

#### 2. **Experience Score (25%)**

```javascript
Min Required | Candidate Exp | Score
-------------|---------------|------
3 years      | 5 years       | 100 (in range)
3 years      | 8 years       | 90  (overqualified)
3 years      | 2.5 years     | 80  (thiáº¿u 20%)
3 years      | 2 years       | 60  (thiáº¿u 40%)
```

#### 3. **Education Score (15%)**

DÃ¹ng `education_levels.rank` Ä‘á»ƒ so sÃ¡nh:

```javascript
Job requires: Bachelor (rank 3)
Candidate has: Master (rank 4)
â†’ Score: 100 (cao hÆ¡n)

Candidate has: Associate (rank 2)
â†’ Score: 80 (kÃ©m 1 báº­c)
```

#### 4. **Location Score (5%)**

- Same city â†’ 100
- Remote/Flexible â†’ 90
- Different city â†’ 30

#### 5. **Salary Score (5%)**

- CÃ³ overlap giá»¯a 2 ranges â†’ 50-100
- Candidate yÃªu cáº§u cao hÆ¡n 10% â†’ 40
- Candidate yÃªu cáº§u cao hÆ¡n 20% â†’ 0

### Total Score Calculation:

```javascript
Total = Skills * 0.5 
      + Experience * 0.25
      + Education * 0.15
      + Location * 0.05
      + Salary * 0.05

is_qualified = Total >= 60
```

### Weights cÃ³ thá»ƒ config trong báº£ng `matching_config`:

```sql
SELECT * FROM matching_config;

 criteria   | weight 
------------|--------
 skills     | 0.50
 experience | 0.25
 education  | 0.15
 location   | 0.05
 salary     | 0.05
```

---

## ğŸ”§ Cáº¤U HÃŒNH

### 1. Update Matching Weights

```javascript
const MatchingModel = require('./models/matching.model');

await MatchingModel.updateMatchingWeights({
  skills: 0.6,      // TÄƒng tá»« 0.5 â†’ 0.6
  experience: 0.2,  // Giáº£m tá»« 0.25 â†’ 0.2
  education: 0.1,
  location: 0.05,
  salary: 0.05
});
```

### 2. Thay Ä‘á»•i Qualified Threshold

Hiá»‡n táº¡i: `is_qualified = total_score >= 60`

CÃ³ thá»ƒ thay Ä‘á»•i trong code:

```javascript
// services/matching.service.js
const isQualified = totalScore >= 70; // TÄƒng tá»« 60 lÃªn 70
```

### 3. Clear Skills Cache

```javascript
const { clearSkillsCache } = require('./utils/textExtractor.improved');

// Sau khi thÃªm/sá»­a skills_master
clearSkillsCache();
```

---

## ğŸ“Š PERFORMANCE

### Optimization Tips:

1. **Index quan trá»ng (Ä‘Ã£ cÃ³):**
```sql
-- GIN index cho JSONB
CREATE INDEX idx_cv_parsed_skills ON cv_parsed_data USING gin(skills);
CREATE INDEX idx_job_parsed_required_skills ON job_parsed_data USING gin(required_skills);

-- B-tree index
CREATE INDEX idx_candidate_skills_user ON candidate_skills(user_id);
CREATE INDEX idx_job_skills_job ON job_skills(job_id);
CREATE INDEX idx_matching_scores_total_score ON matching_scores(total_score DESC);
```

2. **Batch Processing:**
- Match 100 candidates 1 láº§n thay vÃ¬ tá»«ng ngÆ°á»i
- Use Promise.all() nhÆ°ng limit concurrency

3. **Cache:**
- Skills cache (1 hour)
- Matching config cache
- Consider Redis cho large scale

---

## ğŸ› DEBUGGING

### Enable Debug Logs:

```javascript
// services/matching.service.js
console.log(`ğŸ” Starting matching for job ${jobId}`);
console.log(`ğŸ“‹ Job: ${jobData.title}`);
console.log(`ğŸ¯ Job requires ${jobSkills.length} skills`);
console.log(`ğŸ‘¥ Found ${candidates.length} candidates to match`);
console.log(`âœ… Processed ${processed}/${candidates.length} candidates`);
```

### Check Matching Logs:

```sql
SELECT * FROM matching_logs 
WHERE job_id = 123 
ORDER BY created_at DESC 
LIMIT 10;
```

### View Matching Scores:

```sql
SELECT 
  ms.*,
  u.name as candidate_name,
  j.title as job_title
FROM matching_scores ms
JOIN users u ON ms.candidate_id = u.id
JOIN jobs j ON ms.job_id = j.id
WHERE ms.job_id = 123
ORDER BY ms.total_score DESC
LIMIT 20;
```

---

## âš ï¸ LÆ¯U Ã QUAN TRá»ŒNG

### 1. **Pháº£i parse trÆ°á»›c khi match!**

```javascript
// âŒ SAI
await matchingService.matchCandidatesForJob(jobId);
// â†’ Error: Job chÆ°a Ä‘Æ°á»£c parse

// âœ… ÄÃšNG
await JobParserService.parseByJobId(jobId);
await CVParserService.parseByCvId(cvId);
await matchingService.matchCandidatesForJob(jobId);
```

### 2. **Chá»n giá»¯a JSONB vs Relations**

CÃ³ 2 cÃ¡ch lÆ°u skills:

**CÃ¡ch 1: JSONB** (hiá»‡n táº¡i trong parsed_data)
```json
{
  "skills": ["javascript", "react", "nodejs"]
}
```

**CÃ¡ch 2: Relations** (candidate_skills / job_skills)
```sql
candidate_skills:
  user_id | skill_id | proficiency_level
  --------|----------|------------------
  1       | 10       | 5 (Expert)
  1       | 15       | 4 (Advanced)
```

**Khuyáº¿n nghá»‹:** DÃ¹ng Relations (chÃ­nh xÃ¡c hÆ¡n, cÃ³ level)

Set `useRelations: true` khi match:
```javascript
await matchingService.matchCandidatesForJob(jobId, {
  useRelations: true // â† Báº¬T CÃI NÃ€Y
});
```

### 3. **Proficiency Level Mapping**

```javascript
1 = Beginner      (Má»›i há»c)
2 = Basic         (CÆ¡ báº£n)
3 = Intermediate  (Trung bÃ¬nh)
4 = Advanced      (NÃ¢ng cao)
5 = Expert        (ChuyÃªn gia)
```

### 4. **Education Level Mapping**

```javascript
'high_school'  â†’ rank 1
'associate'    â†’ rank 2
'bachelor'     â†’ rank 3
'master'       â†’ rank 4
'phd'          â†’ rank 5
```

---

## ğŸ§ª TESTING

### Test Matching:

```javascript
// Test data
const testJob = {
  id: 123,
  required_skills: ['javascript', 'react'],
  min_experience_years: 3,
  required_education_level: 'bachelor'
};

const testCandidate = {
  user_id: 456,
  skills: ['javascript', 'vue', 'python'],
  total_experience_years: 5,
  education_level: 'master'
};

// Expected result:
// - Skills: 50% (javascript match, react missing)
// - Experience: 100% (5 >= 3)
// - Education: 100% (master > bachelor)
// â†’ Total: 50*0.5 + 100*0.25 + 100*0.15 + ... = ~60%
```

---

## ğŸ“ SUPPORT

Náº¿u cÃ³ váº¥n Ä‘á»:

1. Check logs trong console
2. Check báº£ng `matching_logs`
3. Verify data trong `cv_parsed_data` vÃ  `job_parsed_data`
4. Test vá»›i 1 job + 1 candidate trÆ°á»›c khi scale

---

## ğŸ”„ UPDATE HISTORY

### v1.0 - Initial
- Basic rule-based matching
- Skills + Experience + Education

### v2.0 - Current
- Advanced skills matching vá»›i levels
- Sá»­ dá»¥ng candidate_skills / job_skills tables
- Location + Salary scoring
- Configurable weights
- Performance optimization

---

Táº¥t cáº£ file code Ä‘Ã£ Ä‘Æ°á»£c táº¡o sáºµn. Báº¡n chá»‰ cáº§n:

1. âœ… Copy cÃ¡c file vÃ o project
2. âœ… Cháº¡y parse CV & Job
3. âœ… Cháº¡y matching
4. âœ… Xem káº¿t quáº£

ChÃºc báº¡n thÃ nh cÃ´ng! ğŸš€